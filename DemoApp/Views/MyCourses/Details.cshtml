@model DemoApp.ViewModels.CourseLearningViewModel

@{
    ViewData["Title"] = "Khóa học: " + (Model.KhoaHoc?.TenKhoaHoc ?? "Khóa học");
    var percent = Model.ProgressPercent;
    int activeLessonId = ViewBag.ActiveLessonId != null ? (int)ViewBag.ActiveLessonId : 0;
}

@section Styles {
    <link rel="stylesheet" href="~/css/mycourses.css" />
}

<section class="mc-page">
    <div class="mc-container">

        <!-- Nút quay lại -->
        <button type="button"
                onclick="window.location.href='@Url.Action("Index", "MyCourses")'"
                class="mc-back-link">
            ← Quay lại danh sách khóa học
        </button>

        <!-- Header khóa học -->
        <div class="mc-course-header-card">
            <div class="mc-course-header-left">
                <h1 class="mc-course-header-title">@Model.KhoaHoc?.TenKhoaHoc</h1>
                <p class="mc-course-header-subtitle">@Model.KhoaHoc?.MoTaNgan</p>

                <div class="mc-course-header-progress">
                    <div class="mc-progress-bar mc-progress-bar-lg">
                        <div class="mc-progress-bar-fill" style="width:@percent%;"></div>
                    </div>
                    <div class="mc-course-header-progress-text">
                        @Model.CompletedLessons/@Model.TotalLessons bài học đã hoàn thành
                    </div>
                </div>
            </div>

            <div class="mc-course-header-badge">
                <div class="mc-course-header-badge-title">Tiến độ</div>
                <div class="mc-course-header-badge-value">@percent%</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="mc-tabs">
            <button type="button" class="mc-tab is-active" data-tab="lessons">
                <span class="mc-tab-icon">📖</span>
                <span>Bài học</span>
            </button>
            <button type="button" class="mc-tab" data-tab="attendance">
                <span class="mc-tab-icon">📅</span>
                <span>Điểm danh</span>
            </button>
            <button type="button" class="mc-tab" data-tab="stats">
                <span class="mc-tab-icon">👤</span>
                <span>Thống kê</span>
            </button>
        </div>

        <!-- Panels -->
        <div class="mc-tab-panels">

            <!-- TAB: BÀI HỌC -->
            <div class="mc-tab-panel is-active" data-tab-panel="lessons">
                <div class="mc-lessons-list">
                    @if (Model.Lessons == null || Model.Lessons.Count == 0)
                    {
                        <div class="mc-empty-box">Chưa có bài học nào.</div>
                    }
                    else
                    {
                        var index = 1;
                        bool prevCompleted = true;

                        foreach (var lesson in Model.Lessons)
                        {
                            bool isCompleted = Model.CompletedLessonIds != null
                            && Model.CompletedLessonIds.Contains(lesson.Id);

                            bool canMarkComplete =
                            !isCompleted &&
                            (index == 1 || prevCompleted) &&
                            (lesson.Id == activeLessonId);

                            <article class="mc-lesson-card @(isCompleted ? "mc-lesson-card-completed" : "")">
                                <div class="mc-lesson-left">
                                    <div class="mc-lesson-icon">
                                        @(isCompleted ? "✔" : index.ToString())
                                    </div>
                                    <div class="mc-lesson-text">
                                        <h3 class="mc-lesson-title">@lesson.TenBaiHoc</h3>
                                        <div class="mc-lesson-meta">
                                            ⏱ @(lesson.ThoiLuong > 0 ? $"{lesson.ThoiLuong} phút" : "45 phút")
                                        </div>
                                    </div>
                                </div>

                                <div class="mc-lesson-right">
                                    <button type="button"
                                            class="mc-btn-secondary"
                                            onclick="startLesson(@lesson.Id, '@lesson.DuongDanNoiDung')">
                                        @(isCompleted ? "Xem lại" : "Học ngay")
                                    </button>

                                    @if (canMarkComplete)
                                    {
                                        <form asp-action="CompleteLesson"
                                              asp-controller="MyCourses"
                                              method="post"
                                              class="mc-complete-form"
                                              style="display:inline-block;margin-left:12px;margin-top:6px;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="courseId" value="@Model.KhoaHoc!.Id" />
                                            <input type="hidden" name="lessonId" value="@lesson.Id" />
                                            <button type="submit" class="mc-btn-complete">✓ Hoàn thành</button>
                                        </form>
                                    }
                                </div>
                            </article>

                            prevCompleted = isCompleted;
                            index++;
                        }
                    }
                </div>
            </div>

            <!-- TAB: ĐIỂM DANH -->
            <div class="mc-tab-panel" data-tab-panel="attendance">
                <div class="mc-attendance-wrapper">

                    <!-- Summary card -->
                    <div class="mc-attendance-summary-card">
                        <div>
                            <h3 class="mc-attendance-title">Tỷ lệ điểm danh</h3>
                            <p class="mc-attendance-subtitle">Tổng quan</p>
                        </div>
                        <div class="mc-attendance-rate">
                            @(Model.Stats?.AttendanceRate ?? 0)%
                        </div>
                    </div>

                    <!-- Danh sách buổi học -->
                    <div class="mc-attendance-list">
                        @if (Model.Sessions == null || Model.Sessions.Count == 0)
                        {
                            <div class="mc-empty-box">Chưa có buổi học nào.</div>
                        }
                        else
                        {
                            foreach (var session in Model.Sessions)
                            {
                                var attend = Model.Attendances
                                ?.FirstOrDefault(a => a.BuoiHocId == session.Id);

                                string status = attend?.TrangThai ?? "none";
                                string dateText = attend?.NgayDiemDanh.ToString("dd/MM/yyyy") ?? "";
                                string statusText = status switch
                                {
                                    "present" => "Có mặt",
                                    "late" => "Đi muộn",
                                    "absent" => "Vắng",
                                    _ => "Chưa điểm danh"
                                };

                                <article class="mc-attendance-item">
                                    <div class="mc-attendance-left">
                                        <span class="mc-attendance-dot mc-attendance-dot-@status"></span>
                                        <div>
                                            <div class="mc-attendance-lesson">@session.TenBuoiHoc</div>
                                            @if (!string.IsNullOrEmpty(dateText))
                                            {
                                                <div class="mc-attendance-date">@dateText</div>
                                            }
                                        </div>
                                    </div>

                                    <div class="mc-attendance-right">
                                        <span class="mc-attendance-badge mc-attendance-badge-@status">
                                            @statusText
                                        </span>

                                        @* Nút điểm danh nếu chưa có bản ghi *@
                                        @if (status == "none")
                                        {
                                            <form asp-controller="MyCourses"
                                                  asp-action="CheckIn"
                                                  method="post"
                                                  class="mc-attendance-checkin-form">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="courseId" value="@Model.KhoaHoc!.Id" />
                                                <input type="hidden" name="sessionId" value="@session.Id" />
                                                <button type="submit" class="mc-btn-secondary mc-btn-xs">
                                                    Điểm danh
                                                </button>
                                            </form>
                                        }
                                    </div>
                                </article>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- TAB: THỐNG KÊ -->
            <div class="mc-tab-panel" data-tab-panel="stats">
                <div class="mc-stats-grid">

                    <div class="mc-stat-card mc-stat-card-green">
                        <div class="mc-stat-card-header">
                            <span>Bài học</span>
                            <span class="mc-stat-icon">📖</span>
                        </div>
                        <div class="mc-stat-card-value">
                            @Model.CompletedLessons/@Model.TotalLessons
                        </div>
                        <div class="mc-stat-card-note">Đã hoàn thành</div>
                    </div>

                    <div class="mc-stat-card mc-stat-card-blue">
                        <div class="mc-stat-card-header">
                            <span>Điểm danh</span>
                            <span class="mc-stat-icon">📅</span>
                        </div>
                        <div class="mc-stat-card-value">
                            @(Model.Stats?.AttendanceRate ?? 0)%
                        </div>
                        <div class="mc-stat-card-note">Tỷ lệ tham gia</div>
                    </div>

                    <div class="mc-stat-card mc-stat-card-orange">
                        <div class="mc-stat-card-header">
                            <span>Điểm TB</span>
                            <span class="mc-stat-icon">🏅</span>
                        </div>
                        <div class="mc-stat-card-value">
                            @(Model.Stats?.AvgScore ?? 0)/100
                        </div>
                        <div class="mc-stat-card-note">Điểm trung bình</div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script>
        const detailsBaseUrl = '@Url.Action("Details", "MyCourses", new { id = Model.KhoaHoc!.Id })';

        function startLesson(lessonId, url) {
            window.open(url, '_blank');
            window.location.href = detailsBaseUrl + '?activeLessonId=' + lessonId;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.mc-tab');
            const panels = document.querySelectorAll('.mc-tab-panel');

            tabs.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-tab');

                    tabs.forEach(b => b.classList.remove('is-active'));
                    panels.forEach(p => p.classList.remove('is-active'));

                    btn.classList.add('is-active');
                    document.querySelector('[data-tab-panel="' + target + '"]').classList.add('is-active');
                });
            });
        });
    </script>
}
