@model IEnumerable<DemoApp.Models.KhoaHoc>

@{
    ViewData["Title"] = "Quản lý khóa học";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewBag.ActiveMenu = "courses";

    var totalCourses = Model?.Count() ?? 0;
    var activeCourses = Model?.Count(k => k.TrangThai == "HoatDong") ?? 0;
    var draftCourses = Model?.Count(k => k.TrangThai == "BanNhap") ?? 0;
    var hiddenCourses = Model?.Count(k => k.TrangThai == "DaAn") ?? 0;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-courses.css" />
}

<!-- Page Header -->
<div class="page-header-section">
    <div class="page-header-left">
        <h1 class="page-main-title">Quản lý khóa học</h1>
        <p class="page-description">Xem, lọc và chỉnh sửa các khóa học trên hệ thống</p>
    </div>
    <a href="/admin/courses/create" class="btn-add-new">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Thêm khóa học
    </a>
</div>

<!-- Filter & Search Bar -->
<div class="filter-search-bar">
    <div class="search-wrapper">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" placeholder="Tìm theo tên khóa học, mã khóa học..." class="search-input-modern" id="searchInput" />
    </div>
    <div class="filter-controls">
        <select class="filter-dropdown" id="categoryFilter">
            <option value="">Tất cả danh mục</option>
            @if (ViewBag.DanhMucList != null)
            {
                foreach (var dm in ViewBag.DanhMucList as IEnumerable<DemoApp.Models.DanhMuc>)
                {
                    <option value="@dm.Id">@dm.TenDanhMuc</option>
                }
            }
        </select>
        <select class="filter-dropdown" id="statusFilter">
            <option value="">Tất cả trạng thái</option>
            <option value="HoatDong">Hoạt động</option>
            <option value="BanNhap">Bản nháp</option>
            <option value="DaAn">Đã ẩn</option>
        </select>
        <select class="filter-dropdown" id="levelFilter">
            <option value="">Tất cả cấp độ</option>
            <option value="CoBan">Cơ bản</option>
            <option value="TrungCap">Trung cấp</option>
            <option value="NangCao">Nâng cao</option>
        </select>
    </div>
</div>

<!-- Courses Table -->
<div class="table-container">
    @if (Model != null && Model.Any())
    {
        <table class="courses-table">
            <thead>
                <tr>
                    <th style="width: 80px;">Ảnh</th>
                    <th style="width: 120px;">Mã khóa học</th>
                    <th>Tên khóa học</th>
                    <th style="width: 150px;">Danh mục</th>
                    <th style="width: 100px;">Cấp độ</th>
                    @* <th style="width: 120px;">Giá tiền</th> *@
                    <th style="width: 100px;">Học viên</th>
                    <th style="width: 120px;">Trạng thái</th>
                    <th style="width: 120px;">Ngày tạo</th>
                    <th style="width: 150px;" class="text-center action-col">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var khoaHoc in Model)
                {
                    var statusClass = khoaHoc.TrangThai switch
                    {
                        "HoatDong" => "active",
                        "BanNhap" => "draft",
                        "DaAn" => "inactive",
                        _ => "draft"
                    };

                    var statusText = khoaHoc.TrangThai switch
                    {
                        "HoatDong" => "Hoạt động",
                        "BanNhap" => "Bản nháp",
                        "DaAn" => "Đã ẩn",
                        _ => khoaHoc.TrangThai
                    };

                    var levelText = khoaHoc.CapDo switch
                    {
                        "CoBan" => "Cơ bản",
                        "TrungCap" => "Trung cấp",
                        "NangCao" => "Nâng cao",
                        _ => khoaHoc.CapDo
                    };

                    var categoryName = khoaHoc.DanhMuc?.TenDanhMuc ?? "Chưa phân loại";
                    var soHocVien = khoaHoc.DangKyKhoaHoc?.Count ?? 0;

                    <tr class="course-row"
                        data-category="@(khoaHoc.DanhMucId ?? 0)"
                        data-status="@khoaHoc.TrangThai"
                        data-level="@khoaHoc.CapDo"
                        data-name="@khoaHoc.TenKhoaHoc">
                        <td>
                            @if (!string.IsNullOrEmpty(khoaHoc.AnhBia))
                            {
                                <img src="@khoaHoc.AnhBia" class="table-course-image" />
                            }
                            else
                            {
                                <div class="table-course-placeholder"></div>
                            }
                        </td>
                        <td><span class="course-code">@khoaHoc.MaKhoaHoc</span></td>
                        <td>
                            <div class="course-name-cell">
                                <span class="course-name" title="@khoaHoc.TenKhoaHoc">@khoaHoc.TenKhoaHoc</span>
                                @if (!string.IsNullOrEmpty(khoaHoc.MoTaNgan))
                                {
                                    <span class="course-desc">@khoaHoc.MoTaNgan</span>
                                }
                            </div>
                        </td>
                        <td><span class="category-badge">@categoryName</span></td>
                        <td><span class="level-badge">@levelText</span></td>
                        @* <td><span class="price-text">@khoaHoc.GiaTien.ToString("N0")đ</span></td> *@
                        <td class="text-center">@soHocVien</td>
                        <td>
                            <span class="status-badge @statusClass">@statusText</span>
                        </td>
                        <td>@khoaHoc.NgayTao.ToString("dd/MM/yyyy")</td>
                        <td class="action-col">
                            <div class="action-buttons">
                                <a href="/admin/courses/edit/@khoaHoc.Id"
                                   class="btn-action-text edit-btn">
                                    Sửa
                                </a>

                                <button type="button"
                                        class="btn-action-text delete-btn"
                                        onclick="deleteCourse(@khoaHoc.Id, '@khoaHoc.TenKhoaHoc')">
                                    Xóa
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
            </svg>
            <h3>Chưa có khóa học nào</h3>
            <p>Hãy tạo khóa học đầu tiên của bạn</p>
            <a href="/admin/courses/create" class="btn-add-new">Thêm khóa học</a>
        </div>
    }
</div>

@section Scripts {
    <script>
        function deleteCourse(id, name) {
            if (confirm(`Bạn có chắc chắn muốn xóa khóa học "${name}"?`)) {
                fetch(`/admin/courses/delete/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert('Xóa khóa học thành công!');
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra khi xóa khóa học.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa khóa học.');
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const statusFilter = document.getElementById('statusFilter');
            const levelFilter = document.getElementById('levelFilter');
            const courseRows = Array.from(document.querySelectorAll('.course-row'));

            function filterCourses() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = categoryFilter.value;
                const selectedStatus = statusFilter.value;
                const selectedLevel = levelFilter.value;

                courseRows.forEach(row => {
                    const name = row.dataset.name.toLowerCase();
                    const category = row.dataset.category;
                    const status = row.dataset.status;
                    const level = row.dataset.level;

                    const matchesSearch = name.includes(searchTerm);
                    const matchesCategory = !selectedCategory || category === selectedCategory;
                    const matchesStatus = !selectedStatus || status === selectedStatus;
                    const matchesLevel = !selectedLevel || level === selectedLevel;

                    if (matchesSearch && matchesCategory && matchesStatus && matchesLevel) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterCourses);
            categoryFilter.addEventListener('change', filterCourses);
            statusFilter.addEventListener('change', filterCourses);
            levelFilter.addEventListener('change', filterCourses);
        });
    </script>
}
