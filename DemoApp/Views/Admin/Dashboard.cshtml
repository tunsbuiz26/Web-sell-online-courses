@using System.Text.Json
@model DemoApp.ViewModels.AdminDashboardViewModel

@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Dashboard - Quản trị hệ thống";
    ViewBag.ActiveMenu = "dashboard";

    var labels = Model.RegistrationStats.Select(s => s.CourseName);
    var percents = Model.RegistrationStats.Select(s => Math.Round(s.Percentage, 2));
    var regs = Model.RegistrationStats.Select(s => s.Registrations);

    var labelsJson = JsonSerializer.Serialize(labels);
    var percentsJson = JsonSerializer.Serialize(percents);
    var regsJson = JsonSerializer.Serialize(regs);
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-dashboard.css" />
}

<div class="admin-content">

    <!-- Stats Cards -->
    <div class="stats-grid">

        <!-- Tổng học viên -->
        <div class="stat-card blue">
            <div class="stat-icon">
                <svg width="32" height="32" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">@Model.TotalStudents.ToString("N0")</h3>
                <p class="stat-label">Tổng học viên</p>
            </div>
        </div>

        <!-- Tổng khóa học -->
        <div class="stat-card green">
            <div class="stat-icon">
                <svg width="32" height="32" stroke="currentColor" fill="none" stroke-width="2">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">@Model.TotalCourses.ToString("N0")</h3>
                <p class="stat-label">Tổng khóa học</p>
            </div>
        </div>

        <!-- Tổng lượt đăng ký -->
        <div class="stat-card orange">
            <div class="stat-icon">
                <svg width="32" height="32" stroke="currentColor" fill="none" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path>
                </svg>
            </div>
            <div class="stat-content">
                <h3 class="stat-value">@Model.TotalRegistrations.ToString("N0")</h3>
                <p class="stat-label">Tổng lượt đăng ký</p>
            </div>
        </div>

    </div>

    <!-- Charts Section -->
    <div class="charts-section">

        <!-- Biểu đồ tỉ lệ người đăng ký -->
        <div class="chart-card">
            <div class="card-header">
                <h3 class="card-title">Tỉ lệ đăng ký theo khóa học</h3>
                <p class="card-subtitle">Phần trăm học viên đăng ký từng khóa</p>
            </div>
            <div class="chart-container">
                <canvas id="registrationChart"></canvas>
            </div>
        </div>

        <!-- Top khóa học -->
        <div class="chart-card">
            <div class="card-header">
                <h3 class="card-title">Top khóa học</h3>
                <p class="card-subtitle">Sắp xếp theo số lượt đăng ký (giảm dần)</p>
            </div>

            <div class="top-courses">
                @if (Model.RegistrationStats.Any())
                {
                    var rank = 1;
                    foreach (var course in Model.RegistrationStats.OrderByDescending(x => x.Registrations))
                    {
                        <div class="course-item">
                            <div class="course-rank">@rank</div>
                            <div class="course-info">
                                <h4>@course.CourseName</h4>
                                <p>@course.Registrations.ToString("N0") học viên (@course.Percentage.ToString("0.##")%)</p>
                            </div>
                        </div>
                        rank++;
                    }
                }
                else
                {
                    <p>Chưa có dữ liệu đăng ký khóa học.</p>
                }
            </div>

        </div>
    </div>

</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Dữ liệu cho biểu đồ (từ server)
        window.registrationChartLabels = @Html.Raw(labelsJson);
        window.registrationChartPercents = @Html.Raw(percentsJson);
        window.registrationChartRegs = @Html.Raw(regsJson);
    </script>

    <script src="~/js/admin-dashboard.js"></script>
}
